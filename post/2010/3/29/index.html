<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>MT->WP Log. （WordPress引っ越し記録） - ivoryworks</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/font.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=ivoryworks rel=home><div class="logo__item logo__text"><div class=logo__title>ivoryworks</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>ホーム</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>このサイトについて</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>MT->WP Log. （WordPress引っ越し記録）</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2010-03-29T00:00:00Z>2010/3/29 00:00</time></div></div></header><div class="content post__content clearfix"><p>先日、MovableTypeからWordPressに移行したので作業記録を残す。</p><p>このエントリは移行時の作業メモであり、MovableTypeからWordpressへの移行作業を1から10まで書いていない。　また、本ブログで重要とされてる事柄（主にパーマネントリンク）に対して、本ブログなりの対策を行っているため、全ての方の参考にはならないかもしれない。　つまり『移行ガイド』ではないのでそのつもりで。</p><p>環境は以下のとおり。</p><ul><li>OS:CentOS</li><li>PHP:5.1.6-24</li><li>MySQL:5.0.77</li><li>MovableType:4.27-ja (以降 MT )</li><li>WordPress:2.9.2-ja (以降 WP )</li></ul><p><strong>■パーマネントリンクの解決</strong></p><p>最大の課題。</p><p>完全に移行(MTエントリのURLでWPのエントリにリンクさせる)するか、それとも潔くMTのパーマネントリンクは捨てるか。</p><p>本ブログは移行時点で約400のエントリを持っていて、どちらかと言えばエントリの少ないブログに区分されると思う。</p><p>しかし、ありがたくもソーシャルブックマークされているものや、中には検索エンジンの上位に検出されるエントリも存在するため、それらを完全に無視するのも申し訳ない。</p><p>かと言って、MTでのURLをWPにマッピングして将来的にもMTのならわしでWPを運用し続けていくのも気に食わない。</p><p>結論として、外部サイトからリンクを張られた(リンク切れが発生する)エントリに関しては、apacheのmod_rewriteによりWPにマッピングし、他のエントリに関してはMTのURLを捨てる事とした。</p><p>今後のパーマネントリンクはWPの形式に準ずる事にする。</p><p><strong>■mod_rewriteの実験</strong></p><p>実現したい事は、MTのURLでアクセスしても、移行後のWPエントリが表示される事。　mod_rewriteは正規表現を用いる事ができる等、自由度高く動作指定できるのだけど、期待する動作は1:1の紐付けと、古いURLでアクセスした際に301を返却させる事である。</p><p>全ての設定(RewriteRule)をWPの.htaccessファイルに記述すれば実現するが、httpd.confに記述した方が動作が速くなるそうなのでそうする。</p><p>実験的にWPインストール&MTからのインポートを行い、ちゃんとrewriteされるか色々と試したところ、最初はうまくいかなかった。以下の理由で。</p><ul><li>rewrite設定を記述しても、アクセスしたファイル(つまりrewrite元のファイル)が存在する場合にはrewriteしない。</li><li>該当フォルダに.htaccessファイルが存在し、rewriteの記述が存在する場合にはOverwriteされてしまい(本当?)、httpd.confの記述が有効とならない。</li></ul><p>この事から、前者については移行後は該当しないので問題ないが、後者についてはWPが元々持っている.htaccessファイルが存在する(パーマネントリンクの設定をdefault以外にした場合)ため対策しなくてはならない。</p><p>対策は、WPの.htaccessファイルの内容をhttpd.confに移動させ、.htaccessの中身は無効化（記述削除でもいい）する。</p><p>ちなみに、WPの(.htaccessに自動生成された)rewrite設定は、今回のrewriteマッピング設定よりも後ろに記述する事。そうしないと、全てのアクセスがWPのindex.phpにrewriteされてしまう。不安であれば移行前に色々と実験した方が良い。</p><p>なお、.htaccessの中身をコメントアウトないしファイルそのものを削除して.htaccessの中身を無効としても、後でWPの管理画面よりパーマリンクの設定を更新すると、.htaccessの内容は復活してしまう。</p><p>これにより、いつのまにかmod_rewriteで設定した内容が無効になってしまうので、パーマリンクの設定は以後行わないようにするか、.htaccessをapacheが更新できないよう、ファイルそのもののパーミッションを変更しておく必要がある。これはハマった。</p><p>それでは実際の移行作業に移ろう。</p><p><strong>■DataBaseの作成</strong></p><p>以下の説明では、MySQLのユーザ名をUSER_NAME、パスワードをPASSWD、WPで用いるデータベース名をDATABASE_NAMEとしている。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ unzip wordpress-2.9.2-ja.zip  
</span></span><span style=display:flex><span>Archive: wordpress-2.9.2-ja.zip  
</span></span><span style=display:flex><span>creating: wordpress/  
</span></span><span style=display:flex><span>creating: wordpress/wp-includes/  
</span></span><span style=display:flex><span>:
</span></span></code></pre></div><p>apacheに書き込み権限を与える。</p><p>なお、私のアカウントはapacheグループに所属しているため、一般ユーザでchgrp apacheが可能となっている。できなければrootで実施する事。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ chgrp apache ./wordpress/  
</span></span><span style=display:flex><span>$ chgrp apache ./wordpress/wp-content  
</span></span><span style=display:flex><span>$ chmod g+w ./wordpress/  
</span></span><span style=display:flex><span>$ chmod g+w ./wordpress/wp-content
</span></span></code></pre></div><p>なお、MTとWPを同一フォルダに共存させるため、WPの方はとりあえず「wp_blog」というフォルダ名としておく。</p><p>以上、ディレクトリに適切な権限が付与されていれば、あとはブラウザから設定する事ができる。</p><p>ブラウザから、データベース名等設定する。セキュリティ上不安であればSSL(https://)で接続する。　面倒ならsshで接続して直にconfigファイルを編集したり、ローカルで編集したconfigファイルをFTPでアップロードしても良い(WordPress自体がこの方法を推奨している）。</p><p>設定が完了すればadminというユーザが生成され、ブラウザに初期パスワードが表示される。これをメモしておく。</p><p>ログインボタンを押下する。</p><p>アカウントをadminとし、パスワードは先ほどメモしたものを入力する。</p><p>WPのダッシュボードが表示される。</p><p>まずは新規アカウントの生成（adminを使い続けても良いのだが気持ちが悪い）。</p><p>管理者権限を与える。</p><p>adminをログアウトし、新たに生成したアカウントでログイン。</p><p>adminをコンテンツごと削除する（『すべての投稿とリンクを削除』を選択）。</p><p>これで何もない(まっさらな)WPができあがる。</p><p><strong>■WPへのインポート</strong></p><p>MTからエクスポートしたファイルをインポートする。</p><p>当ブログは、エントリ数が少ないのでエクスポートファイルが2MB以内に収まったが、2MBを超える場合には、ファイル名をmt-export.txtとし、/wp-content/に格納してからブラウザを操作する。</p><p>要するにインポートページに書いてあるようにする。</p><p><strong>■投稿者の割り当て</strong></p><p>インポートするエントリの投稿者をWPのユーザに割り当てる。先ほど生成したユーザ（つまり今ログインしている唯一のユーザ）に割り当てる。</p><p><strong>■パーマリンクの設定</strong></p><p>[設定]→[パーマリンク設定]</p><p>『カスタム構造』を選択し、以下を指定した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/%year%/%monthnum%/%post_id%
</span></span></code></pre></div><p><strong>■Rewriteの設定</strong></p><p>いよいよ。</p><p><strong>■Movabletypeからデータのエクスポート</strong></p><p>メニュー：[ツール]→[エクスポート]で、『ブログをエクスポート』ボタンを押下。</p><p>画像などのバイナリデータは含まれていないので、MTの環境はまだ捨ててはならない。</p><p><strong>■外部サイトからのリンク抽出</strong></p><p>この作業はGoogleのウェブマスター ツールが適している。</p><p><a href="https://www.google.com/webmasters/tools/home?hl=ja">Google ウェブマスター ツール</a></p><p>ダッシュボードの『サイトへのリンク』から詳細ページに遷移すると、リンク情報をcsv形式のファイルでダウンロードする事ができる。</p><p>ブログへのリンクのみを抽出するためにスクリプトを書いた。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>スクリプトは失われました。すみません。
</span></span></code></pre></div><p>もしも、あなたがこのスクリプトを利用する場合には、strstrの引数を修正する必要がある。</p><p>スクリプトは以下のように用いる。Gg_BlogLink.txtに抽出されたURLが記録される。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ php BlogLinkExtract.php ダウンロードしたCSVファイル名 &gt; Gg_BlogLink.txt
</span></span></code></pre></div><p><strong>■WordPressのURLとエントリタイトルの取得</strong></p><p>MTからインポートしたエントリをエクスポートする(WPでのURLが欲しいので)。</p><p>以下のスクリプトを書いた。このスクリプトを実行すると、WPのURLとそれぞれのエントリタイトルが得られる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>スクリプトは失われました。すみません。
</span></span></code></pre></div><p>このように使う。結果はWP_BlogLink.txtに書き出される。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ php WPExportXMLExtract.php WPからエクスポートしたファイル名 &gt; WP_BlogLink.txt
</span></span></code></pre></div><p><strong>■MovabletypeのURLとエントリタイトルの取得</strong></p><p>ブログのアーカイブページを表示させページソースからURLとエントリタイトルを手動でファイルに保存する(MT_BlogLink.txt)。ここ、いきなり原始的になるが、手っ取り早いのでこうした。</p><p>残すファイルの内容は、URLとエントリタイトルをカンマ区切りにして1行に1エントリとする。</p><p>要するに、上記で抽出したWPの抽出内容と同じ形式にする。なお、ファイル保存時の文字エンコーディングは忘れずにUTF-8としておくこと。</p><p><strong>■RewriteRuleの自動生成</strong></p><p>これまでに準備した3つのファイル( Gg_BlogLink.txt, WP_BlogLink.txt, MT_BlogLink.txt)を元に、以下スクリプトでRewriteRuleを自動生成する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>スクリプトは失われました。すみません。
</span></span></code></pre></div><p>こんな感じで実行すると、httpd.confに記載すべきRewriteRuleが吐かれます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ php CreateRewriteRule.php &gt; RewriteRule.txt
</span></span></code></pre></div><p><strong>■ブログのフォルダを入れ替える(rename)</strong></p><ul><li>MTのフォルダ：blog</li><li>WPのフォルダ：wp_blog</li></ul><p>という状況なので以下の手順で入れ替える。</p><p>WPの設定画面（[設定]→[一般]）で、アドレスを変更する。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>設定前  
</span></span><span style=display:flex><span>WordPress のアドレス <span style=color:#f92672>(</span>URL<span style=color:#f92672>)</span> http://www.ivoryworks.com/wp_blog  
</span></span><span style=display:flex><span>ブログのアドレス <span style=color:#f92672>(</span>URL<span style=color:#f92672>)</span> http://www.ivoryworks.com/wp_blog  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>設定後  
</span></span><span style=display:flex><span>WordPress のアドレス <span style=color:#f92672>(</span>URL<span style=color:#f92672>)</span> http://www.ivoryworks.com/blog  
</span></span><span style=display:flex><span>ブログのアドレス <span style=color:#f92672>(</span>URL<span style=color:#f92672>)</span> http://www.ivoryworks.com/blog
</span></span></code></pre></div><p>アドレスを変更した事により、『変更を保存』ボタンを押下すると元のページに戻れなくなるが問題ない。</p><p>次に、MTのフォルダをrenameする。例えば『blog』→『mt_blog』というように。</p><p>最後に、WPのフォルダ名をrenameする。『wp_blog』→『blog』</p><p>おしまい。</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/web%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC/ rel=tag>Webサーバー</a></li></ul></div></footer></article></main></div><aside class=sidebar><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/android/ title=Android>Android</a>
<a class="widget-taglist__link widget__link btn" href=/tags/hugo/ title=Hugo>Hugo</a>
<a class="widget-taglist__link widget__link btn" href=/tags/linux/ title=Linux>Linux</a>
<a class="widget-taglist__link widget__link btn" href=/tags/notion/ title=Notion>Notion</a>
<a class="widget-taglist__link widget__link btn" href=/tags/php/ title=PHP>PHP</a>
<a class="widget-taglist__link widget__link btn" href=/tags/thinkpad/ title=ThinkPad>ThinkPad</a>
<a class="widget-taglist__link widget__link btn" href=/tags/web%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC/ title=Webサーバー>Webサーバー</a>
<a class="widget-taglist__link widget__link btn" href=/tags/web%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9/ title=Webサービス>Webサービス</a>
<a class="widget-taglist__link widget__link btn" href=/tags/zaurus/ title=Zaurus>Zaurus</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E3%81%A9%E3%81%86%E6%9B%B8%E3%81%8F/ title=どう書く？>どう書く？</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E3%82%B9%E3%82%BF%E3%83%91%E3%82%AF%E3%83%A9%E3%82%A6%E3%83%89/ title=スタパクラウド>スタパクラウド</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E3%83%84%E3%83%BC%E3%83%AB/ title=ツール>ツール</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E5%AE%9F%E7%94%A8-r-%E3%82%A2%E3%83%8A%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0/ title="実用 R アナグラミング">実用 R アナグラミング</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E7%A7%80%E4%B8%B8/ title=秀丸>秀丸</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E9%9B%91%E8%A8%98/ title=雑記>雑記</a></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 ivoryworks.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>